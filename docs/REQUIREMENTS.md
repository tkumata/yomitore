# 要件定義書: 読解力トレーニング CLI (yomitore)

**バージョン**: 0.1.10
**最終更新日**: 2026-01-19

## 改訂履歴

| Version | Date        | Change Log                                                       |
| ------- | ----------- | ---------------------------------------------------------------- |
| 0.1.10  | 2026-01-19  | Update prompt strategy (Prompt Repetition), evaluation logic fix |
| 0.1.9   | 2025-12-06  | API timeout, Improving error handling, Update terminal size      |
| 0.1.0   | 1st Release | 1st Release                                                      |

## 1. 概要

### 1.1. プロジェクトの目的

本プロジェクトは、GroqCloud API を活用した対話型の TUI (Terminal User Interface) アプリケーションを開発することを目的とする。ユーザーは、AI が生成した堅い文章を要約するトレーニングを通じて、読解力および要約能力を向上させることができる。

### 1.2. ターゲットユーザー

- 文章の読解や要約に苦手意識を持つ学生や社会人
- 簡潔で的確な文章作成能力を鍛えたい全ての個人

### 1.3. 開発言語

- Rust

## 2. 機能要件

### 2.1. 認証機能

- アプリケーション起動時に、以下の方法で GroqCloud API キーを取得する：
  1. 保存された設定ファイル (`~/.config/yomitore/config.toml`)から読み込む
  2. 環境変数 `GROQ_API_KEY` から読み込む
- 入力された API キーの有効性を検証する (`/models` エンドポイント)
- 認証に成功した API キーは設定ファイルに保存する (Unix 系では 600 パーミッション)
- 認証失敗時はエラーメッセージを表示し、アプリケーションを終了する

### 2.2. メニュー機能

- 起動後、文字数選択メニューを表示する
- 選択可能な文字数：400, 720, 1440, 2880
- メニュー操作：
  - `↑/↓` または `j/k`: 選択
  - `Enter`: トレーニング開始
  - `r`: レポート表示
  - `h`: ヘルプ表示
  - `q`: 終了

### 2.3. 文章生成機能

- 選択された文字数に基づき、GroqCloud API に文章生成を要求する
- **プロンプト**: "日本の公的文書および新聞記事に共通する、客観的で簡潔かつ形式的な文体で、感情的表現や口語表現を避けた文章をN文字程度で生成してください。" (推論能力のないLLMの性能向上のため、このプロンプトを2回繰り返して送信する)
- API タイムアウト: 60 秒
- 生成された文章を画面左半分に表示する
- スクロール機能を提供する (`↑/↓` または `j/k`)

### 2.4. 要約入力機能

- 画面右半分にテキストエリアを表示する
- モード切り替え：
  - `i` または `Enter`: 入力モードに切り替え
  - `Esc`: 通常モードに戻る
- 入力モードでは以下の操作が可能：
  - 文字入力、改行、削除
  - カーソル移動 (矢印キー、Home/End)
  - 自動ワードラップ
- `Ctrl+S`: 要約を送信して評価を受ける

### 2.5. 要約評価機能

- ユーザーの入力送信後、以下の情報を GroqCloud API に送信する：
  - **原文**: アプリケーションが生成した文章
  - **要約文**: ユーザーが入力した文章
- **評価プロンプト**: 「はい」または「いいえ」で判定し、5 段階評価を含む詳細なフィードバックを提供
- **合格判定基準**: 評価結果に「総合評価: 合格」という文字列が含まれていること
- API タイムアウト: 60 秒
- 評価中は "Evaluating..." メッセージを表示

### 2.6. 結果表示機能

- 評価結果をオーバーレイ (画面の 75%) で表示する
- 合格/不合格に応じて枠線の色を変更 (緑/赤)
- スクロール機能を提供する (`Shift+↑/↓` または `Shift+j/k`)
- 操作：
  - `e`: 評価結果の表示/非表示切り替え
  - `n`: 次のトレーニングへ

### 2.7. 統計・レポート機能

- トレーニング結果を `~/.config/yomitore/stats.json` に保存する
- 統計情報：
  - 日次集計 (過去 30 日)
  - 週次集計 (過去 4 週)
  - 正解/不正解の内訳
  - 現在の連続正解数
- バッジシステム：
  - 連続正解バッジ (5 連ごと、最大 50 連)
  - 累積正解バッジ (5 正解ごと、最大累積 100)
- レポート表示：
  - `r`キーでレポート画面を表示/非表示
  - 月次・週次統計、獲得バッジを表示

### 2.8. ヘルプ機能

- `h`キーでヘルプ画面を表示/非表示
- `docs/HELP.md` の内容を表示
- スクロール機能を提供する（`↑/↓` または `j/k`）

### 2.8. バディ育成機能

- レポート画面に「バディ」を表示する
- **成長ルール**: トレーニングに5回合格するとレベルアップする
- **ペナルティ**: 最終トレーニングから3日（72時間）以上経過するとレベルが下がる（レベル1未満にはならない）
- **見た目**: レベルに応じた ASCII アートで表現する

## 3. 非機能要件

### 3.1. 実行環境

- ターミナル上で動作するクロスプラットフォーム (Windows, macOS, Linux) の TUI アプリケーション
- 最小ターミナルサイズ：100 文字 × 30 行
- 推奨ターミナルサイズ：120 文字以上 × 40 行以上
- UTF-8 エンコーディング対応

### 3.2. ユーザーインターフェース

- ratatui を使用した豊富な TUI
- リアルタイムレンダリング (100ms ごとのイベントポーリング)
- レスポンシブレイアウト (画面サイズに応じた動的調整)
- カラー表示 (ANSI 色対応)

### 3.3. パフォーマンス

- **API タイムアウト**: 60 秒
- **イベント応答**: 100ms 以内
- **画面更新**: スムーズなスクロールとレンダリング
- **メモリ使用**: 適切なメモリ管理 (不要なデータの即時解放)

### 3.4. セキュリティ

- API キーは設定ファイルに暗号化せずに保存 (ファイルパーミッションで保護)
- Unix 系システムでは設定ファイルを 600 パーミッション (所有者のみ読み書き可能) で保存
- 環境変数からの読み込みをサポート

### 3.5. エラーハンドリング

- API 通信の失敗時、アプリケーションはクラッシュせず適切なエラーメッセージを表示
- エラー種別：
  - ネットワークエラー
  - API タイムアウト
  - 無効な API キー
  - レスポンス解析エラー
  - ファイル I/O エラー
- 統計保存失敗時、ステータスバーに Warning メッセージを表示
- すべてのエラーはユーザーに通知される

### 3.6. データ永続化

- 設定ファイル: `~/.config/yomitore/config.toml` (TOML 形式)
- 統計ファイル: `~/.config/yomitore/stats.json` (JSON 形式)
- ディレクトリが存在しない場合は自動作成
- データの整合性を保証 (JSON スキーマ検証)
- 過去データとの互換性維持

### 3.7. 終了方法

- `q` キーで正常終了
- `Ctrl+C` のシグナルを検知した場合、ターミナル状態を復元してから終了
- 異常終了時もターミナル状態を可能な限り復元

### 3.8. 保守性・拡張性

- モジュール分割による責務の明確化
- 定数による設定の一元管理
- ユニットテストの実装
- ドキュメントの整備

### 3.9. テスト要件

- 実際の GroqCloud API を利用せずに評価結果までの動作を検証できること
- テストはモジュール単位で実行できること（例: `cargo test api_client`, `cargo test stats`, `cargo test config`, `cargo test error`）
- 各モジュールにおいて正常系、異常系、境界値（スコアの範囲外、記号の揺らぎ等）を網羅するテストを実装すること
- 評価結果のパースは純粋関数で実装し、8行必須・順序自由・数値は 1〜5・壊れた形式は Err とする
- 評価結果は固定順で表示し、数値は 1〜5 の値をそのまま表示する
- パース失敗時は「評価結果の形式が不正です」と表示する
- レポートに直近30日の平均・中央値・件数を表示する
- 評価結果の余分な行は無視し、先頭の箇条書き記号が異なっていても解釈する

## 評価結果ダイアログ余白追加

- 評価結果ダイアログの外側に余白を追加する
- 余白の量は上下左右とも半角英数字2文字分とする
- 余白は最小サイズ制約より優先する
- 対象は評価結果ダイアログのみとする
